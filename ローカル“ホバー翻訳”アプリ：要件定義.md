# ローカル“ホバー翻訳”アプリ：要件定義（Electron / macOS 専用）

最終更新: 2025-09-22（JST） / 作成対象: 非エンジニアの個人開発者（AIエージェント活用前提） / 主開発OS: macOS（Intel は検証対象外）

---

## 0. エグゼクティブサマリ
- **目的**: macOS 上で、画面選択 → OCR → 翻訳 → HUD 表示を 1 フローで完結させるローカルアプリを Electron で完成させる。
- **設計方針**: ①ホバー翻訳体験を最優先（スクリーンショット前提）②フェーズ分割で MVP を高速に実装 ③ macOS の権限取得と依存管理を最初に解決 ④ 既存コード再利用を前提とせず、必要コンポーネントを明示的に定義。
- **MVP 目標（Phase 3 まで）**: ⌘⇧4 等で取得した範囲キャプチャを自動 OCR → 翻訳 → HUD 表示（マウス近傍） / 処理時間 6 秒以内 / 主要設定は再起動後も保持。
- **配布**: 開発中は未署名の `.app` を手動配布。完成時は Developer ID 署名 + notarization を実施。

---

## 1. 背景と失敗要因の克服
1. **機能ゴールの不一致解消**: D&D 翻訳とホバー翻訳を混在させず、「スクリーンショット → 翻訳 → HUD」の単一体験に絞る。
2. **スタック統一**: Tauri ではなく Electron + Node.js で開発。Rust プラグインは使用しない。
3. **権限設計の先出し**: macOS の Screen Recording 権限をオンボーディングで取得。権限未許可時はガイドを表示。
4. **再利用コードへの依存排除**: 既存 `src/services/*` は想定しない。必要コンポーネントを本要件内で定義。
5. **フェーズ制御**: 各フェーズに完了条件と検証方法を明示し、長期化を防ぐ。

---

## 2. スコープ
### 2.1 フェーズ別スコープ
- **Phase 0（準備）**: 開発環境構築、Electron テンプレート生成、コード署名用証明書確認。
- **Phase 1（静的 HUD）**: 常時最前面 HUD ウィンドウ生成、固定テキスト表示、手動閉じ。
- **Phase 2（翻訳基盤）**: 選択テキスト入力欄 → 外部翻訳 API 呼び出し → HUD 表示。OCR は未実装。
- **Phase 3（スクリーンショット + OCR）**: macOS Screen Recording 取得 → 範囲キャプチャ → OCR → 翻訳 → HUD。ここで MVP 達成。
- **Phase 4（UX 改善）**: ホバー自動トリガー、ヒストリー表示、ショートカットカスタム。
- **Phase 5（配布・保守）**: 署名、公証、バージョン管理、エラー監視。

### 2.2 MVP 機能（Phase 3 完了時）
1. 範囲キャプチャ取得（ユーザー操作 or ショートカット）
2. OCR（英/日対応）
3. 翻訳（DeepL API Free を推奨）
4. HUD 表示（原文・訳文、コピー、閉じる）
5. 設定保存：翻訳先言語、ショートカット、ウィンドウ位置

### 2.3 スコープ外（v1 では実施しない）
- Windows / Linux 対応
- オンデバイス大規模言語モデル
- 自動アップデート配信
- 多言語 UI

---

## 3. 想定ユーザーと利用シナリオ
- **ユーザー**: 海外ソフトの UI やドキュメントを読みたい個人開発者。英語力は中級以下。コーディング経験は限定的。
- **シナリオ A**: ユーザーが英語 UI を ⌘⇧4 でキャプチャ → アプリが自動で OCR + 翻訳 → HUD で訳文表示。
- **シナリオ B**: 翻訳 API の月間制限に達したとき、ユーザーが API キーを入れ替え（または手動入力）して再実行。
- **シナリオ C**: 翻訳後の文章をコピーしてノートに保存。HUD を移動しながら別作業を継続。

---

## 4. 非機能要件と指標
- **性能**: M1/M2 Mac で 1920x1080 のスクリーンショットを OCR + 翻訳して 6 秒以内に HUD 表示。
- **信頼性**: 連続 20 回のスクリーンショット翻訳で失敗率 5% 未満。API エラー時は再試行ボタン表示。
- **可用性**: 設定は `~/Library/Application Support/HoverTranslate/config.json` に保存し、再起動後も復元。
- **セキュリティ / プライバシ**: 画像はローカルで一時保存（翻訳 API 送信前に削除）。翻訳 API は HTTPS 経由、キーは macOS Keychain に保管。
- **操作性**: HUD はマウス近傍に表示し、ドラッグで移動、Esc キーで閉じる。全操作をキーボードのみで完結可能。

---

## 5. アーキテクチャ概要
```
[Main Process]
  ├─ AppLifecycleManager         // 起動・権限チェック・クラッシュハンドリング
  ├─ CaptureService (desktopCapturer + CGImage) // 範囲キャプチャ
  ├─ OCRService (tesseract.js via worker)        // 画像→テキスト
  ├─ TranslationService (DeepL API wrapper)      // テキスト→訳文
  ├─ HUDWindowManager             // BrowserWindow 制御
  └─ SettingsStore (electron-store + Keychain)
[Renderer Process (HUD)]
  ├─ HUD UI (React or Vanilla)    // 表示 & 交互
  └─ IPC Bridge                   // 結果表示 / 再翻訳 / 設定更新
[Worker Threads]
  └─ OCR Worker                   // 重い処理をメインから分離
```

---

## 6. コンポーネント要件
### 6.1 CaptureService
- Electron `desktopCapturer` で全画面キャプチャ。
- macOS Screen Recording 権限が未取得の場合、システム環境設定を開くダイアログを表示。
- 範囲指定は `CGWindowListCreateImage` を活用するネイティブアドオン or `electron-screenshot` の採用を検討。
- 取得画像は `~/Library/Caches/HoverTranslate/temp.png` に一時保存し、処理後に削除。

### 6.2 OCRService
- `tesseract.js` を Node Worker Threads で呼び出す。
- サポート言語: `eng`, `jpn`; 言語データは初回起動時に `%APP_SUPPORT%/tessdata` へ配置。
- OCR 結果に信頼度スコアを含め、閾値未満の場合は再試行を促すメッセージを追加。

### 6.3 TranslationService
- 既定は DeepL API Free（`deepl-node`）。
- API キーは初回起動時に入力ダイアログで登録し、Keychain に保存。代替として Google Cloud Translation を構成可能。
- API エラー（429/5xx）は指数バックオフで 2 回までリトライ。

### 6.4 HUDWindowManager
- フレームレス + 透過ウィンドウ。サイズは 320x400px を目安。
- 結果表示用の `hud.html` をロード。UI はコンポーネントベース（React + Tailwind 推奨）。
- `autoHideDuration`（例: 15 秒）とユーザー操作による固定モードを提供。

### 6.5 SettingsStore
- `electron-store` で JSON 永続化。
- 保存項目: 翻訳言語、ショートカット、HUD 位置、API 設定、OCR 言語。
- 機密値は Keychain（`keytar`）で保持。

---

## 7. 権限とセキュリティ設計
1. 初回起動時に Screen Recording 権限ガイドを表示。許可後アプリを自動再起動。
2. クリップボードや Accessibility 権限は要求しない。
3. ログには機微情報を記録しない。デバッグログは `~/Library/Logs/HoverTranslate.log`。
4. 一時ファイル削除を `finally` ブロックで保証。

---

## 8. 実装ロードマップ（12 週間想定）
- **Week 1**: Electron プロジェクト生成、Lint/Formatter、基本 HUD ウィンドウ。
- **Week 2-3**: SettingsStore 実装、DeepL API 疎通、手動テキスト翻訳ルート完成。
- **Week 4-5**: Screen Recording ガイドと全画面キャプチャ実装。
- **Week 6-7**: OCR Worker 実装、画像 → テキスト パイプライン完成。
- **Week 8**: HUD UI 調整（コピー、再翻訳ボタン、エラーハンドリング）。
- **Week 9**: ショートカット（`globalShortcut`）でキャプチャ起動。設定画面簡易版。
- **Week 10**: テストスイート整備（Jest + Playwright）、手動テストチェックリスト作成。
- **Week 11**: 署名・公証手順確立、CI（GitHub Actions）で lint/test 自動化。
- **Week 12**: バグ修正、リリースノート、ドキュメント最終化。

---

## 9. テスト計画
- **ユニットテスト**: 翻訳サービス、設定ストア（Jest）。
- **統合テスト**: Playwright で HUD 表示と IPC を検証。
- **シナリオテスト**: 3 種類のスクリーンショット（英語 UI、小フォント、背景ノイズ）で 5 回ずつ実施。
- **権限テスト**: 権限未許可状態からの起動 → ガイド表示 → 再起動フローの確認。

---

## 10. リスクと対策
- **スクリーンショット失敗**: 権限未許可、マルチディスプレイ対応ミス → 権限チェックとディスプレイ選択 UI を実装。
- **OCR 速度不足**: 大きな画像に時間がかかる → 事前に 2 倍縮小、閾値以下なら部分 OCR を案内。
- **翻訳 API 制限**: 無料枠超過 → 使用量表示と API キー切り替えガイドを提供。
- **HUD 操作性**: 透明ウィンドウのドラッグ検出 → ドラッグハンドル領域を UI に用意。

---

## 11. 受け入れ条件
- Phase 3 完了時、以下を満たすこと:
  - Screen Recording 権限取得後、ショートカット 1 回で翻訳結果が HUD に表示される。
  - 処理時間 6 秒以内。成功率 95% 以上。
  - DeepL API キーを GUI で登録し、Keychain に格納。
  - 設定変更（言語、ショートカット）が再起動後も保持。

---

## 12. 配布と保守
- ビルド: `npm run build` → `electron-builder` で `.dmg` 生成。
- 署名: `codesign` + `notarytool`。手順書を `docs/signing.md` に記載。
- 配布: GitHub Releases にドラフトアップロード。自動更新は次期開発事項。
- 監視: 初期はローカルログのみ。将来は Sentry 導入を検討。

---

## 13. ドキュメントとサポート
- `README.md`: セットアップ、コマンド、主要機能。
- `docs/` ディレクトリ: 権限ガイド、API キー設定、FAQ。
- チェックリスト: 開発フェーズごとに Notion or Markdown で管理。

---

> 本要件は「スクリーンショット → OCR → 翻訳 → HUD」のコア体験に集中し、権限・環境・依存関係を先に解決することで非エンジニアでも完走できるルートを示しています。各フェーズは AI エージェントに依頼するタスク単位に分解できるよう設計されています。
