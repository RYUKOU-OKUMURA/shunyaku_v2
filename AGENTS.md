# AGENTS.md - Shunyaku v2 開発実行ガイド

最終更新: 2025-09-30  
対象: AIエージェント（開発実行担当）  
プロジェクト: ローカル"ホバー翻訳"アプリ（Electron / macOS専用）

---

## 0. このドキュメントの目的

このドキュメントは、Shunyaku v2プロジェクトの開発を**正確に実行する**ためのAIエージェント向けガイドです。

### 重要な原則
1. **タスクは1つずつ実行する** - 並行作業は禁止
2. **実装完了時は必ずチェックボックスにチェックを入れる**
3. **実装報告を必ず行う** - 何をどう実装したかを明確に記録
4. **GitHubへのコミットとプッシュ実行許可を確認する** - 全ての変更をバージョン管理
5. **検証条件を満たすまで次に進まない**

---

## 1. 必須ワークフロー

### 1.1 タスク実行の基本フロー

```
[タスク選択] 
    ↓
[実装前確認]
    ↓
[実装作業]
    ↓
[テスト実行]
    ↓
[検証条件確認]
    ↓
[チェックボックス更新] ← 必須
    ↓
[実装報告作成] ← 必須
    ↓
[Git コミット & プッシュをユーザーへ確認] ← 必須
    ↓
[次タスクへ]
```

### 1.2 タスク実行の詳細手順

#### ステップ1: タスク選択
- IMPLEMENTATION_PLAN.mdから未完了タスク（☐）を1つ選択
- 依存関係を確認し、前提タスクが完了していることを確認
- 選択したタスクを明示的に宣言

#### ステップ2: 実装前確認
以下を確認してから実装開始:
```markdown
## 実装前チェックリスト
- [ ] 前提タスクが全て完了している
- [ ] 必要な依存パッケージがインストール済み
- [ ] 関連ドキュメントを読んで理解した
- [ ] 検証条件が明確になっている
```

#### ステップ3: 実装作業
- コードを書く
- 必要に応じてファイルを作成
- コメントとJSDocを適切に記述
- ESLintエラーがないことを確認

#### ステップ4: テスト実行
- ユニットテストを作成（該当する場合）
- `npm test` を実行
- 全てのテストがパスすることを確認
- 手動動作確認を実施

#### ステップ5: 検証条件確認
- タスクの**検証条件**を満たしているか確認
- 満たしていない場合は実装に戻る

#### ステップ6: チェックボックス更新（必須）
IMPLEMENTATION_PLAN.mdの該当チェックボックスを更新:
```markdown
変更前: - [ ] 0.1.1 Node.js v18+ インストール確認
変更後: - [x] 0.1.1 Node.js v18+ インストール確認
```

#### ステップ7: 実装報告作成（必須）
以下のフォーマットで報告を作成:

```markdown
## 実装報告: [タスク番号] [タスク名]

**実施日時**: YYYY-MM-DD HH:MM

### 実装内容
- 何を実装したか（ファイル、関数、機能）
- どのように実装したか（アプローチ、技術選択）

### 作成・変更ファイル
- `path/to/file1.js` - 作成/変更の理由
- `path/to/file2.js` - 作成/変更の理由

### テスト結果
- ユニットテスト: ✅ 全てパス / ❌ 失敗
- 手動テスト: ✅ 正常動作 / ❌ 問題あり
- 検証条件: ✅ 満たす / ❌ 満たさない

### 検証条件の確認
[タスクの検証条件をここに記載し、満たしていることを確認]

### 次のタスク
[次に実行すべきタスク番号とタスク名]

### 備考
[特記事項、問題点、今後の改善点など]
```

#### ステップ8: Git コミット & プッシュをユーザーへ確認（必須）
```bash
# ステージング
git add .

# コミット（わかりやすいメッセージ）
git commit -m "[タスク番号] タスク名の完了

- 実装内容の要約
- 作成/変更したファイル
- 検証結果"

# プッシュ
git push origin main

# プッシュ確認
git log --oneline -1
```

**重要**: コミットメッセージには必ずタスク番号を含める

---

## 2. プロジェクト概要

### 2.1 目標
macOS上で「スクリーンショット → OCR → 翻訳 → HUD表示」を1フローで完結させるローカルアプリをElectronで実装する。

### 2.2 MVP定義（Phase 3完了時）
1. 範囲キャプチャ取得（ユーザー操作 or ショートカット）
2. OCR（英/日対応）
3. 翻訳（DeepL API Free）
4. HUD表示（原文・訳文、コピー、閉じる）
5. 設定保存：翻訳先言語、ショートカット、ウィンドウ位置

### 2.3 技術スタック
- **フレームワーク**: Electron
- **言語**: JavaScript (Node.js)
- **テスト**: Jest, Playwright
- **OCR**: tesseract.js
- **翻訳API**: DeepL API (deepl-node)
- **設定管理**: electron-store, keytar

### 2.4 開発期間
12週間（84日間）

---

## 3. フェーズ別タスクリスト

### Phase 0: 環境準備（Week 1: 1-5日目）

#### タスク 0.1: 開発環境セットアップ
- [ ] 0.1.1 Node.js v18+ インストール確認
- [ ] 0.1.2 npm依存関係インストール
- [ ] 0.1.3 Electronプロジェクト構造確認
- [ ] 0.1.4 VSCodeまたは推奨エディタ設定
- [ ] 0.1.5 Git初期化と.gitignore設定

**検証条件**: `npm test` が正常実行される

#### タスク 0.2: コード品質ツール設定
- [ ] 0.2.1 ESLintインストールと設定ファイル作成
- [ ] 0.2.2 Prettierインストールと設定
- [ ] 0.2.3 pre-commitフック設定（husky）
- [ ] 0.2.4 package.jsonにlint/formatスクリプト追加

**検証条件**: `npm run lint` が実行可能

#### タスク 0.3: 証明書とApple Developer確認
- [ ] 0.3.1 Apple Developer Program登録確認
- [ ] 0.3.2 Developer ID証明書の取得状況確認
- [ ] 0.3.3 証明書の有効期限確認
- [ ] 0.3.4 署名手順のドキュメント化（docs/signing.md）

**検証条件**: 証明書情報が確認できる

---

### Phase 1: 静的HUDウィンドウ（Week 1: 6-7日目）

#### タスク 1.1: 基本Electronアプリ構造
- [ ] 1.1.1 main.js作成（アプリエントリーポイント）
- [ ] 1.1.2 package.jsonのmainフィールド設定
- [ ] 1.1.3 アプリ起動とquit処理実装
- [ ] 1.1.4 macOS特有のアプリ動作実装（dock表示制御）

**検証条件**: `npm start` でElectronアプリが起動する

#### タスク 1.2: HUDウィンドウの基本実装
- [ ] 1.2.1 BrowserWindow生成（フレームレス、透過設定）
- [ ] 1.2.2 hud.html作成（基本HTML構造）
- [ ] 1.2.3 hud.css作成（スタイリング、透過対応）
- [ ] 1.2.4 常時最前面設定（alwaysOnTop, level: 'floating'）
- [ ] 1.2.5 固定テキスト表示テスト

**検証条件**: HUDウィンドウが最前面に透過表示される

#### タスク 1.3: HUD基本操作
- [ ] 1.3.1 ウィンドウドラッグ機能実装
- [ ] 1.3.2 閉じるボタン実装
- [ ] 1.3.3 Escキーで閉じる機能
- [ ] 1.3.4 マウス位置近傍への表示位置調整

**検証条件**: HUDの移動と閉じる操作が正常動作

---

### Phase 2: 翻訳基盤（Week 2-3: 8-21日目）

#### タスク 2.1: 設定管理システム
- [ ] 2.1.1 electron-storeインストール
- [ ] 2.1.2 SettingsStore.js作成
- [ ] 2.1.3 設定スキーマ定義（言語、ショートカット等）
- [ ] 2.1.4 デフォルト設定値の定義
- [ ] 2.1.5 設定読み書きメソッド実装
- [ ] 2.1.6 ユニットテスト作成（Jest）

**検証条件**: 設定の保存・読み込みテストが全てパス

#### タスク 2.2: API キー管理（Keychain連携）
- [ ] 2.2.1 keytarインストール
- [ ] 2.2.2 KeychainManager.js作成
- [ ] 2.2.3 APIキー保存メソッド実装
- [ ] 2.2.4 APIキー取得メソッド実装
- [ ] 2.2.5 APIキー削除メソッド実装
- [ ] 2.2.6 エラーハンドリング実装

**検証条件**: KeychainにAPIキーが保存され取得できる

#### タスク 2.3: DeepL API連携
- [ ] 2.3.1 deepl-nodeインストール
- [ ] 2.3.2 TranslationService.js作成
- [ ] 2.3.3 DeepL APIクライアント初期化
- [ ] 2.3.4 翻訳メソッド実装（基本）
- [ ] 2.3.5 エラーハンドリング（429, 5xx）
- [ ] 2.3.6 リトライロジック実装（指数バックオフ）
- [ ] 2.3.7 ユニットテスト作成（モック使用）

**検証条件**: DeepL APIで翻訳が成功する

#### タスク 2.4: APIキー入力UI
- [ ] 2.4.1 settings.html作成（設定画面）
- [ ] 2.4.2 APIキー入力フォーム実装
- [ ] 2.4.3 保存ボタンとIPC通信実装
- [ ] 2.4.4 設定ウィンドウ表示ロジック（main.js）
- [ ] 2.4.5 バリデーション実装

**検証条件**: GUIでAPIキーを登録しKeychainに保存される

#### タスク 2.5: 手動テキスト翻訳フロー
- [ ] 2.5.1 HUDにテキスト入力欄追加
- [ ] 2.5.2 翻訳ボタン実装
- [ ] 2.5.3 IPC通信（Renderer → Main → TranslationService）
- [ ] 2.5.4 翻訳結果のHUD表示
- [ ] 2.5.5 ローディングインジケーター追加
- [ ] 2.5.6 エラー表示実装

**検証条件**: 手動入力テキストが翻訳されHUDに表示される

---

### Phase 3: スクリーンショット + OCR（Week 4-7: 22-49日目）

#### タスク 3.1: macOS権限管理
- [ ] 3.1.1 Screen Recording権限チェックロジック実装
- [ ] 3.1.2 権限未許可時のガイドダイアログ作成
- [ ] 3.1.3 システム環境設定を開く処理実装
- [ ] 3.1.4 権限取得後の自動再起動ロジック
- [ ] 3.1.5 AppLifecycleManager.js作成

**検証条件**: 権限未許可→ガイド表示→設定→再起動が動作

#### タスク 3.2: スクリーンキャプチャ実装
- [ ] 3.2.1 desktopCapturerでの画面キャプチャ実装
- [ ] 3.2.2 CaptureService.js作成
- [ ] 3.2.3 マルチディスプレイ対応
- [ ] 3.2.4 範囲選択UI実装（または外部ツール連携検討）
- [ ] 3.2.5 キャプチャ画像の一時保存（~/Library/Caches/）
- [ ] 3.2.6 画像ファイル削除ロジック（finallyブロック）

**検証条件**: スクリーンショットが正常に取得・保存される

#### タスク 3.3: OCRエンジン実装
- [ ] 3.3.1 tesseract.jsインストール
- [ ] 3.3.2 OCRWorker.js作成（Worker Threads使用）
- [ ] 3.3.3 OCRService.js作成（Workerラッパー）
- [ ] 3.3.4 言語データダウンロード処理（eng, jpn）
- [ ] 3.3.5 tessdata配置処理（%APP_SUPPORT%/tessdata）
- [ ] 3.3.6 OCR実行メソッド実装
- [ ] 3.3.7 信頼度スコアチェック実装
- [ ] 3.3.8 画像前処理（2倍縮小）実装

**検証条件**: 画像からテキストが抽出される（精度80%以上）

#### タスク 3.4: 完全フロー統合
- [ ] 3.4.1 mainプロセスでのフロー制御実装
- [ ] 3.4.2 Capture → OCR → Translation → HUD表示の連携
- [ ] 3.4.3 エラーハンドリング各段階で実装
- [ ] 3.4.4 処理時間計測ロジック追加
- [ ] 3.4.5 パフォーマンス最適化（6秒以内目標）

**検証条件**: ショートカット→翻訳結果表示が6秒以内

#### タスク 3.5: HUD UI改善
- [ ] 3.5.1 原文・訳文の見やすい表示レイアウト
- [ ] 3.5.2 コピーボタン実装（clipboard API）
- [ ] 3.5.3 再翻訳ボタン実装
- [ ] 3.5.4 エラーメッセージ表示エリア
- [ ] 3.5.5 ローディングアニメーション改善
- [ ] 3.5.6 React or Vanillaでのコンポーネント化

**検証条件**: HUD UIが直感的で操作しやすい

#### タスク 3.6: グローバルショートカット
- [ ] 3.6.1 globalShortcutモジュール実装
- [ ] 3.6.2 デフォルトショートカット設定（例: ⌘⇧T）
- [ ] 3.6.3 ショートカット登録・解除ロジック
- [ ] 3.6.4 設定画面でのショートカットカスタマイズUI
- [ ] 3.6.5 競合検出と警告表示

**検証条件**: ショートカットでキャプチャが起動する

---

### Phase 4: UX改善（Week 8-9: 50-63日目）

#### タスク 4.1: HUD自動表示制御
- [ ] 4.1.1 autoHideDuration設定実装（デフォルト15秒）
- [ ] 4.1.2 タイマー処理実装
- [ ] 4.1.3 ユーザー操作時のタイマーリセット
- [ ] 4.1.4 固定モード切り替えボタン追加

**検証条件**: 15秒後にHUDが自動で閉じる

#### タスク 4.2: 翻訳履歴機能
- [ ] 4.2.1 履歴保存ロジック実装（electron-store）
- [ ] 4.2.2 履歴表示UI作成（history.html）
- [ ] 4.2.3 履歴検索機能実装
- [ ] 4.2.4 履歴削除機能実装
- [ ] 4.2.5 履歴件数制限（最大100件）

**検証条件**: 過去の翻訳履歴が確認できる

#### タスク 4.3: 設定画面の充実
- [ ] 4.3.1 言語選択UI実装
- [ ] 4.3.2 OCR言語選択実装
- [ ] 4.3.3 ショートカットカスタマイズUI
- [ ] 4.3.4 HUDサイズ・位置設定
- [ ] 4.3.5 テーマ設定（ダーク/ライトモード）

**検証条件**: 全設定が変更でき永続化される

#### タスク 4.4: エラーリカバリ機能
- [ ] 4.4.1 API制限エラー時の代替案表示
- [ ] 4.4.2 OCR失敗時の手動入力フォールバック
- [ ] 4.4.3 ネットワークエラー時のオフライン表示
- [ ] 4.4.4 再試行ボタンの実装

**検証条件**: エラー時に適切なガイダンスが表示される

---

### Phase 5: 配布・保守（Week 10-12: 64-84日目）

#### タスク 5.1: テストスイート整備
- [ ] 5.1.1 Jestテスト全モジュールカバー（目標80%）
- [ ] 5.1.2 Playwrightインストールと設定
- [ ] 5.1.3 E2Eテストシナリオ作成
- [ ] 5.1.4 手動テストチェックリスト作成
- [ ] 5.1.5 シナリオテスト実施（英語UI、小フォント、ノイズ）
- [ ] 5.1.6 権限テスト実施

**検証条件**: 全テストがパスし成功率95%以上

#### タスク 5.2: ビルドとパッケージング
- [ ] 5.2.1 electron-builderインストール
- [ ] 5.2.2 build設定（package.json）
- [ ] 5.2.3 アイコン作成（.icns）
- [ ] 5.2.4 DMGビルドスクリプト作成
- [ ] 5.2.5 ビルド検証（手動インストールテスト）

**検証条件**: DMGから正常にインストールできる

#### タスク 5.3: コード署名と公証
- [ ] 5.3.1 codesign実行スクリプト作成
- [ ] 5.3.2 notarytoolでの公証実行
- [ ] 5.3.3 公証確認（stapler）
- [ ] 5.3.4 署名済みDMGの動作確認
- [ ] 5.3.5 docs/signing.md詳細化

**検証条件**: 署名済みアプリがGatekeeperを通過する

#### タスク 5.4: CI/CD設定
- [ ] 5.4.1 GitHub Actions設定ファイル作成
- [ ] 5.4.2 lint/testの自動実行設定
- [ ] 5.4.3 ビルド自動化（PRごと）
- [ ] 5.4.4 Secretsの設定（証明書、APIキー）

**検証条件**: PRでCIが自動実行される

#### タスク 5.5: ドキュメント整備
- [ ] 5.5.1 README.md完成版作成
- [ ] 5.5.2 docs/setup.md作成（セットアップ手順）
- [ ] 5.5.3 docs/permissions.md作成（権限ガイド）
- [ ] 5.5.4 docs/api-keys.md作成（APIキー設定）
- [ ] 5.5.5 docs/faq.md作成
- [ ] 5.5.6 CHANGELOG.md作成

**検証条件**: 新規ユーザーがREADMEのみでセットアップ可能

#### タスク 5.6: リリース準備
- [ ] 5.6.1 バージョン番号確定（v1.0.0）
- [ ] 5.6.2 リリースノート作成
- [ ] 5.6.3 GitHub Release作成
- [ ] 5.6.4 DMGアップロード
- [ ] 5.6.5 配布テスト（別Mac環境）

**検証条件**: 第三者がダウンロードして使用できる

---

## 4. 完了定義 (Definition of Done)

**各タスク完了時、以下を全て満たすこと:**

1. ✅ コードが実装されている
2. ✅ ユニットテストが書かれている（該当する場合）
3. ✅ テストが全てパスしている
4. ✅ ESLintエラーがゼロ
5. ✅ 手動動作確認が完了している
6. ✅ 関連ドキュメントが更新されている
7. ✅ コミットメッセージが適切
8. ✅ **IMPLEMENTATION_PLAN.mdのチェックボックスが更新されている**
9. ✅ **実装報告が作成されている**
10. ✅ **GitHubへのコミット・プッシュをユーザーへ確認する**

---

## 5. Git コミット規約

### 5.1 コミットメッセージフォーマット

```
[タスク番号] タスクの簡潔な説明

- 実装内容の詳細1
- 実装内容の詳細2
- 作成/変更ファイル

検証: [検証条件を満たしたことを記載]
```

### 5.2 コミット例

```
[0.1.2] npm依存関係インストール

- package.jsonに開発依存関係を追加
- jest, eslint, prettier をインストール
- npm install を実行し node_modules を生成

検証: npm test が正常実行されることを確認
```

### 5.3 プッシュ確認

毎回プッシュ後、以下を確認:
```bash
# 最新コミットを確認
git log --oneline -1

# リモートとの同期確認
git status

# GitHub上で確認（ブラウザまたはGitHub CLI）
gh repo view --web
```

---

## 6. トラブルシューティング

### 6.1 タスクが完了できない場合

1. **依存タスクの確認**: 前提タスクが完了しているか確認
2. **エラーログの確認**: エラーメッセージを詳細に確認
3. **ドキュメントの再確認**: 要件定義とガイドラインを再読
4. **テストの作成**: 小さなテストケースで問題を切り分け
5. **報告**: 問題を明確に記述し、人間の開発者に相談

### 6.2 検証条件を満たせない場合

1. 実装を見直す
2. テストケースを追加
3. 手動で複数回動作確認
4. 検証条件が不明確な場合は明確化を依頼
5. 必要に応じて検証条件の調整を提案

---

## 7. 禁止事項

### 絶対にやってはいけないこと

1. ❌ **複数タスクの同時実行** - 必ず1つずつ
2. ❌ **チェックボックスの更新忘れ** - 完了したら必ず更新
3. ❌ **実装報告の省略** - 必ず作成
4. ❌ **Gitコミット・プッシュを勝手に実行** - 必ずユーザーに許可を確認する
5. ❌ **検証条件の無視** - 満たすまで次に進まない
6. ❌ **テストの省略** - 該当する場合は必ず作成
7. ❌ **ドキュメントの更新忘れ** - 関連ドキュメントは常に最新に
8. ❌ **エラーの放置** - 全てのエラーに対処

---

## 8. 進捗報告フォーマット

### 8.1 日次進捗報告

```markdown
# 日次進捗報告 - YYYY-MM-DD

## 完了タスク
- [x] [タスク番号] タスク名 - 所要時間: N時間

## 実装内容サマリ
- 主要な実装内容1
- 主要な実装内容2

## テスト結果
- ユニットテスト: N件実施、全てパス
- 手動テスト: 正常動作確認

## 作成・変更ファイル
- `path/to/file1.js`
- `path/to/file2.js`

## Git状況
- コミット数: N件
- プッシュ: 完了 ✅

## 次のタスク
- [ ] [次タスク番号] 次タスク名

## 問題・課題
- なし / 問題がある場合は詳細に記載

## 備考
- 特記事項
```

### 8.2 週次進捗報告

```markdown
# 週次進捗報告 - Week N (YYYY-MM-DD ~ YYYY-MM-DD)

## 完了タスク数
- Phase N: M/L タスク完了

## 主要成果物
- 成果物1
- 成果物2

## マイルストーン進捗
- [ ] M1: 環境準備完了
- [x] M2: 静的HUD表示
- [ ] M3: 手動翻訳動作

## KPI
- テストカバレッジ: XX%
- コミット数: N件
- エラー件数: N件

## 課題とリスク
- 課題1: 詳細
- 対策: 対策内容

## 次週予定
- タスク番号 X.X.X ~ X.X.X の実施
```

---

## 9. 参照ドキュメント

### 9.1 必読ドキュメント
1. **要件定義**: `ローカル"ホバー翻訳"アプリ：要件定義.md`
2. **実装計画**: `IMPLEMENTATION_PLAN.md`
3. **開発ガイドライン**: `.junie/guidelines.md`

### 9.2 外部リソース
- [Electron Documentation](https://www.electronjs.org/docs)
- [Jest Documentation](https://jestjs.io/docs/getting-started)
- [DeepL API Documentation](https://www.deepl.com/docs-api)
- [Tesseract.js Documentation](https://tesseract.projectnaptha.com/)

---

## 10. チェックリスト：このドキュメントを使う前に

開発開始前に以下を確認:

- [ ] このドキュメント (AGENT.md) を最初から最後まで読んだ
- [ ] ワークフローを理解した
- [ ] 完了定義 (DoD) を理解した
- [ ] Git規約を理解した
- [ ] 禁止事項を理解した
- [ ] 参照ドキュメントを全て読んだ
- [ ] 開発環境が準備できている

**全てチェックが入ったら、タスク 0.1.1 から開始してください。**

---

## 付録A: クイックリファレンス

### タスク実行の8ステップ
1. タスク選択
2. 実装前確認
3. 実装作業
4. テスト実行
5. 検証条件確認
6. ✅ チェックボックス更新
7. ✅ 実装報告作成
8. ✅ Git コミット & プッシュ

### 必須3アクション
1. **チェックボックス更新** - IMPLEMENTATION_PLAN.mdを編集
2. **実装報告作成** - 何をどう実装したか明記
3. **Git操作** - commit → push → 確認

### よく使うコマンド
```bash
# テスト実行
npm test

# Lint実行
npm run lint

# Gitコミット
git add .
git commit -m "[タスク番号] メッセージ"
git push origin main

# Git確認
git log --oneline -5
git status
```

---

**このドキュメントを守ることで、正確で追跡可能な開発が実現します。**  
**必ず1つずつタスクを完了させ、全ての記録を残してください。**

---

最終更新: 2025-09-30  
バージョン: 1.0.0