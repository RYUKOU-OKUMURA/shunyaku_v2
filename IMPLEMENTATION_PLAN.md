# Shunyaku v2 実装計画書

作成日: 2025-09-30  
プロジェクト: ローカル"ホバー翻訳"アプリ（Electron / macOS専用）  
開発期間: 12週間想定

---

## 目次
1. [プロジェクト概要](#1-プロジェクト概要)
2. [フェーズ別タスク分解](#2-フェーズ別タスク分解)
3. [コンポーネント別実装タスク](#3-コンポーネント別実装タスク)
4. [週次スケジュール](#4-週次スケジュール)
5. [依存関係マップ](#5-依存関係マップ)
6. [検証チェックリスト](#6-検証チェックリスト)

---

## 1. プロジェクト概要

### 1.1 目標
macOS上で「スクリーンショット → OCR → 翻訳 → HUD表示」を1フローで完結させるローカルアプリをElectronで実装する。

### 1.2 MVP定義（Phase 3完了時）
- 範囲キャプチャ取得（ショートカット対応）
- OCR処理（英語・日本語対応）
- DeepL API連携による翻訳
- HUD表示（原文・訳文、コピー、閉じる機能）
- 設定の永続化（再起動後も保持）

### 1.3 技術スタック
- **フレームワーク**: Electron
- **言語**: JavaScript (Node.js)
- **テスト**: Jest, Playwright
- **OCR**: tesseract.js
- **翻訳API**: DeepL API (deepl-node)
- **設定管理**: electron-store, keytar

---

## 2. フェーズ別タスク分解

### Phase 0: 環境準備（Week 1: 1-5日目）

#### タスク 0.1: 開発環境セットアップ
- [x] 0.1.1 Node.js v18+ インストール確認
- [x] 0.1.2 npm依存関係インストール
- [x] 0.1.3 Electronプロジェクト構造確認
- [x] 0.1.4 VSCodeまたは推奨エディタ設定
- [x] 0.1.5 Git初期化と.gitignore設定

**検証条件**: `npm test` が正常実行される

#### タスク 0.2: コード品質ツール設定
- [x] 0.2.1 ESLintインストールと設定ファイル作成
- [x] 0.2.2 Prettierインストールと設定
- [x] 0.2.3 pre-commitフック設定（husky）
- [x] 0.2.4 package.jsonにlint/formatスクリプト追加

**検証条件**: `npm run lint` が実行可能

#### タスク 0.3: 証明書とApple Developer確認
- [x] 0.3.1 Apple Developer Program登録確認
- [x] 0.3.2 Developer ID証明書の取得状況確認
- [x] 0.3.3 証明書の有効期限確認
- [x] 0.3.4 署名手順のドキュメント化（docs/signing.md）

**検証条件**: 証明書情報が確認できる

---

### Phase 1: 静的HUDウィンドウ（Week 1: 6-7日目）

#### タスク 1.1: 基本Electronアプリ構造
- [x] 1.1.1 main.js作成（アプリエントリーポイント）
- [x] 1.1.2 package.jsonのmainフィールド設定
- [x] 1.1.3 アプリ起動とquit処理実装
- [x] 1.1.4 macOS特有のアプリ動作実装（dock表示制御）

**検証条件**: `npm start` でElectronアプリが起動する

#### タスク 1.2: HUDウィンドウの基本実装
- [x] 1.2.1 BrowserWindow生成（フレームレス、透過設定）
- [x] 1.2.2 hud.html作成（基本HTML構造）
- [x] 1.2.3 hud.css作成（スタイリング、透過対応）
- [x] 1.2.4 常時最前面設定（alwaysOnTop, level: 'floating'）
- [x] 1.2.5 固定テキスト表示テスト

**検証条件**: HUDウィンドウが最前面に透過表示される

#### タスク 1.3: HUD基本操作
- [x] 1.3.1 ウィンドウドラッグ機能実装
- [x] 1.3.2 閉じるボタン実装
- [x] 1.3.3 Escキーで閉じる機能
- [x] 1.3.4 マウス位置近傍への表示位置調整

**検証条件**: HUDの移動と閉じる操作が正常動作

---

### Phase 2: 翻訳基盤（Week 2-3: 8-21日目）

#### タスク 2.1: 設定管理システム
- [x] 2.1.1 electron-storeインストール
- [x] 2.1.2 SettingsStore.js作成
- [x] 2.1.3 設定スキーマ定義（言語、ショートカット等）
- [x] 2.1.4 デフォルト設定値の定義
- [x] 2.1.5 設定読み書きメソッド実装
- [x] 2.1.6 ユニットテスト作成（Jest）

**検証条件**: 設定の保存・読み込みテストが全てパス

#### タスク 2.2: API キー管理（Keychain連携）
- [x] 2.2.1 keytarインストール
- [x] 2.2.2 KeychainManager.js作成
- [x] 2.2.3 APIキー保存メソッド実装
- [x] 2.2.4 APIキー取得メソッド実装
- [x] 2.2.5 APIキー削除メソッド実装
- [x] 2.2.6 エラーハンドリング実装

**検証条件**: KeychainにAPIキーが保存され取得できる

#### タスク 2.3: DeepL API連携
- [x] 2.3.1 deepl-nodeインストール
- [x] 2.3.2 TranslationService.js作成
- [x] 2.3.3 DeepL APIクライアント初期化
- [x] 2.3.4 翻訳メソッド実装（基本）
- [x] 2.3.5 エラーハンドリング（429, 5xx）
- [x] 2.3.6 リトライロジック実装（指数バックオフ）
- [x] 2.3.7 ユニットテスト作成（モック使用）

**検証条件**: DeepL APIで翻訳が成功する

#### タスク 2.4: APIキー入力UI
- [x] 2.4.1 settings.html作成（設定画面）
- [x] 2.4.2 APIキー入力フォーム実装
- [x] 2.4.3 保存ボタンとIPC通信実装
- [x] 2.4.4 設定ウィンドウ表示ロジック（main.js）
- [x] 2.4.5 バリデーション実装

**検証条件**: GUIでAPIキーを登録しKeychainに保存される

#### タスク 2.5: 手動テキスト翻訳フロー
- [x] 2.5.1 HUDにテキスト入力欄追加
- [x] 2.5.2 翻訳ボタン実装
- [x] 2.5.3 IPC通信（Renderer → Main → TranslationService）
- [x] 2.5.4 翻訳結果のHUD表示
- [x] 2.5.5 ローディングインジケーター追加
- [x] 2.5.6 エラー表示実装

**検証条件**: 手動入力テキストが翻訳されHUDに表示される

---

### Phase 3: スクリーンショット + OCR（Week 4-7: 22-49日目）

#### タスク 3.1: macOS権限管理
- [x] 3.1.1 Screen Recording権限チェックロジック実装
- [x] 3.1.2 権限未許可時のガイドダイアログ作成
- [x] 3.1.3 システム環境設定を開く処理実装
- [x] 3.1.4 権限取得後の自動再起動ロジック
- [x] 3.1.5 AppLifecycleManager.js作成

**検証条件**: 権限未許可→ガイド表示→設定→再起動が動作

#### タスク 3.2: スクリーンキャプチャ実装
- [x] 3.2.1 desktopCapturerでの画面キャプチャ実装
- [x] 3.2.2 CaptureService.js作成
- [x] 3.2.3 マルチディスプレイ対応
- [x] 3.2.4 範囲選択UI実装（または外部ツール連携検討）
- [x] 3.2.5 キャプチャ画像の一時保存（~/Library/Caches/）
- [x] 3.2.6 画像ファイル削除ロジック（finallyブロック）

**検証条件**: スクリーンショットが正常に取得・保存される

#### タスク 3.3: OCRエンジン実装
- [x] 3.3.1 tesseract.jsインストール
- [x] 3.3.2 OCRWorker.js作成（Worker Threads使用）
- [x] 3.3.3 OCRService.js作成（Workerラッパー）
- [x] 3.3.4 言語データダウンロード処理（eng, jpn）
- [x] 3.3.5 tessdata配置処理（%APP_SUPPORT%/tessdata）
- [x] 3.3.6 OCR実行メソッド実装
- [x] 3.3.7 信頼度スコアチェック実装
- [x] 3.3.8 画像前処理（2倍縮小）実装

**検証条件**: 画像からテキストが抽出される（精度80%以上）

#### タスク 3.4: 完全フロー統合
- [x] 3.4.1 mainプロセスでのフロー制御実装
- [x] 3.4.2 Capture → OCR → Translation → HUD表示の連携
- [x] 3.4.3 エラーハンドリング各段階で実装
- [x] 3.4.4 処理時間計測ロジック追加
- [x] 3.4.5 パフォーマンス最適化（6秒以内目標）

**検証条件**: ショートカット→翻訳結果表示が6秒以内

#### タスク 3.5: HUD UI改善
- [x] 3.5.1 原文・訳文の見やすい表示レイアウト
- [x] 3.5.2 コピーボタン実装（clipboard API）
- [x] 3.5.3 再翻訳ボタン実装
- [x] 3.5.4 エラーメッセージ表示エリア
- [x] 3.5.5 ローディングアニメーション改善
- [x] 3.5.6 React or Vanillaでのコンポーネント化

**検証条件**: HUD UIが直感的で操作しやすい

#### タスク 3.6: グローバルショートカット
- [x] 3.6.1 globalShortcutモジュール実装
- [x] 3.6.2 デフォルトショートカット設定（例: ⌘⇧T）
- [x] 3.6.3 ショートカット登録・解除ロジック
- [x] 3.6.4 設定画面でのショートカットカスタマイズUI
- [x] 3.6.5 競合検出と警告表示

**検証条件**: ショートカットでキャプチャが起動する

---

### Phase 4: UX改善（Week 8-9: 50-63日目）

#### タスク 4.1: HUD自動表示制御
- [x] 4.1.1 autoHideDuration設定実装（デフォルト15秒）
- [x] 4.1.2 タイマー処理実装
- [x] 4.1.3 ユーザー操作時のタイマーリセット
- [x] 4.1.4 固定モード切り替えボタン追加

**検証条件**: 15秒後にHUDが自動で閉じる

#### タスク 4.2: 翻訳履歴機能
- [x] 4.2.1 履歴保存ロジック実装（electron-store）
- [x] 4.2.2 履歴表示UI作成（history.html）
- [x] 4.2.3 履歴検索機能実装
- [x] 4.2.4 履歴削除機能実装
- [x] 4.2.5 履歴件数制限（最大100件）

**検証条件**: 過去の翻訳履歴が確認できる

#### タスク 4.3: 設定画面の充実
- [x] 4.3.1 言語選択UI実装
- [x] 4.3.2 OCR言語選択実装
- [x] 4.3.3 ショートカットカスタマイズUI
- [x] 4.3.4 HUDサイズ・位置設定
- [x] 4.3.5 テーマ設定（ダーク/ライトモード）

**検証条件**: 全設定が変更でき永続化される

#### タスク 4.4: エラーリカバリ機能
- [x] 4.4.1 API制限エラー時の代替案表示
- [x] 4.4.2 OCR失敗時の手動入力フォールバック
- [x] 4.4.3 ネットワークエラー時のオフライン表示
- [x] 4.4.4 再試行ボタンの実装

**検証条件**: エラー時に適切なガイダンスが表示される

---

### Phase 5: 配布・保守（Week 10-12: 64-84日目）

#### タスク 5.1: テストスイート整備
- [ ] 5.1.1 Jestテスト全モジュールカバー（目標80%）
- [ ] 5.1.2 Playwrightインストールと設定
- [ ] 5.1.3 E2Eテストシナリオ作成
- [ ] 5.1.4 手動テストチェックリスト作成
- [ ] 5.1.5 シナリオテスト実施（英語UI、小フォント、ノイズ）
- [ ] 5.1.6 権限テスト実施

**検証条件**: 全テストがパスし成功率95%以上

#### タスク 5.2: ビルドとパッケージング
- [ ] 5.2.1 electron-builderインストール
- [ ] 5.2.2 build設定（package.json）
- [ ] 5.2.3 アイコン作成（.icns）
- [ ] 5.2.4 DMGビルドスクリプト作成
- [ ] 5.2.5 ビルド検証（手動インストールテスト）

**検証条件**: DMGから正常にインストールできる

#### タスク 5.3: コード署名と公証
- [ ] 5.3.1 codesign実行スクリプト作成
- [ ] 5.3.2 notarytoolでの公証実行
- [ ] 5.3.3 公証確認（stapler）
- [ ] 5.3.4 署名済みDMGの動作確認
- [ ] 5.3.5 docs/signing.md詳細化

**検証条件**: 署名済みアプリがGatekeeperを通過する

#### タスク 5.4: CI/CD設定
- [ ] 5.4.1 GitHub Actions設定ファイル作成
- [ ] 5.4.2 lint/testの自動実行設定
- [ ] 5.4.3 ビルド自動化（PRごと）
- [ ] 5.4.4 Secretsの設定（証明書、APIキー）

**検証条件**: PRでCIが自動実行される

#### タスク 5.5: ドキュメント整備
- [ ] 5.5.1 README.md完成版作成
- [ ] 5.5.2 docs/setup.md作成（セットアップ手順）
- [ ] 5.5.3 docs/permissions.md作成（権限ガイド）
- [ ] 5.5.4 docs/api-keys.md作成（APIキー設定）
- [ ] 5.5.5 docs/faq.md作成
- [ ] 5.5.6 CHANGELOG.md作成

**検証条件**: 新規ユーザーがREADMEのみでセットアップ可能

#### タスク 5.6: リリース準備
- [ ] 5.6.1 バージョン番号確定（v1.0.0）
- [ ] 5.6.2 リリースノート作成
- [ ] 5.6.3 GitHub Release作成
- [ ] 5.6.4 DMGアップロード
- [ ] 5.6.5 配布テスト（別Mac環境）

**検証条件**: 第三者がダウンロードして使用できる

---

## 3. コンポーネント別実装タスク

### 3.1 AppLifecycleManager
**ファイル**: `src/main/AppLifecycleManager.js`

- [ ] app.on('ready')ハンドラ実装
- [ ] 権限チェック処理
- [ ] 初回起動判定とオンボーディング
- [ ] クラッシュハンドリング（uncaughtException）
- [ ] 再起動ロジック

### 3.2 CaptureService
**ファイル**: `src/services/CaptureService.js`

- [ ] desktopCapturerラッパー実装
- [ ] 画面選択UI（マルチディスプレイ）
- [ ] 範囲キャプチャ取得
- [ ] 画像保存（PNG形式）
- [ ] 一時ファイル管理

### 3.3 OCRService
**ファイル**: `src/services/OCRService.js`

- [ ] Workerスレッド起動
- [ ] tesseract.js初期化
- [ ] 画像前処理（リサイズ）
- [ ] OCR実行と結果パース
- [ ] 信頼度評価
- [ ] エラーハンドリング

### 3.4 TranslationService
**ファイル**: `src/services/TranslationService.js`

- [ ] DeepL APIクライアント初期化
- [ ] 翻訳リクエスト処理
- [ ] レスポンスパース
- [ ] エラーハンドリング
- [ ] リトライロジック
- [ ] 使用量トラッキング

### 3.5 HUDWindowManager
**ファイル**: `src/main/HUDWindowManager.js`

- [ ] BrowserWindow生成
- [ ] ウィンドウ設定（フレームレス、透過）
- [ ] 位置制御（マウス近傍）
- [ ] IPC通信ハンドラ
- [ ] ウィンドウライフサイクル管理

### 3.6 SettingsStore
**ファイル**: `src/services/SettingsStore.js`

- [ ] electron-storeインスタンス生成
- [ ] スキーマ定義
- [ ] getter/setterメソッド
- [ ] マイグレーションロジック
- [ ] バリデーション

### 3.7 KeychainManager
**ファイル**: `src/services/KeychainManager.js`

- [x] keytarラッパー実装
- [x] APIキー保存
- [x] APIキー取得
- [x] APIキー削除
- [x] エラーハンドリング

---

## 4. 週次スケジュール

### Week 1: 基礎構築
- **Day 1-3**: 環境セットアップ、コード品質ツール設定
- **Day 4-5**: 証明書確認、ドキュメント準備
- **Day 6-7**: Electron基本構造、静的HUDウィンドウ

**成果物**: 起動可能なElectronアプリ、固定テキスト表示HUD

### Week 2: 設定管理とAPI連携基盤
- **Day 8-10**: SettingsStore実装、テスト作成
- **Day 11-12**: KeychainManager実装
- **Day 13-14**: TranslationService基本実装

**成果物**: 設定の永続化、APIキー管理機能

### Week 3: 手動翻訳フロー完成
- **Day 15-17**: DeepL API完全統合、リトライロジック
- **Day 18-19**: APIキー入力UI実装
- **Day 20-21**: 手動テキスト翻訳フロー完成、テスト

**成果物**: テキスト入力→翻訳→HUD表示の動作確認

### Week 4: 権限とキャプチャ
- **Day 22-24**: macOS権限管理実装
- **Day 25-28**: CaptureService実装、マルチディスプレイ対応

**成果物**: Screen Recording権限取得、スクリーンショット機能

### Week 5: キャプチャ完成度向上
- **Day 29-31**: 範囲選択UI実装
- **Day 32-35**: 画像管理、エラーハンドリング強化

**成果物**: 安定したキャプチャ機能

### Week 6: OCR実装
- **Day 36-38**: tesseract.js統合、Worker実装
- **Day 39-42**: 言語データ管理、OCR精度向上

**成果物**: 画像→テキスト変換機能

### Week 7: フル統合
- **Day 43-45**: Capture → OCR → Translation統合
- **Day 46-49**: パフォーマンス最適化、HUD UI改善

**成果物**: MVP動作（6秒以内の処理）

### Week 8: グローバルショートカットとUI改善
- **Day 50-52**: globalShortcut実装
- **Day 53-56**: HUD UI最終調整、コピー機能、再翻訳

**成果物**: ショートカットでの起動、完成度の高いHUD

### Week 9: UX機能追加
- **Day 57-59**: 自動非表示、履歴機能
- **Day 60-63**: 設定画面充実、エラーリカバリ

**成果物**: 実用レベルのUX

### Week 10: テスト整備
- **Day 64-66**: Jestテスト全モジュール
- **Day 67-70**: Playwrightテスト、手動テスト実施

**成果物**: テストカバレッジ80%以上

### Week 11: ビルドと署名
- **Day 71-73**: electron-builderセットアップ、DMG作成
- **Day 74-77**: コード署名、公証、CI/CD設定

**成果物**: 署名済みDMG、自動化CI

### Week 12: リリース準備
- **Day 78-80**: ドキュメント完成
- **Day 81-82**: リリースノート作成、配布テスト
- **Day 83-84**: バグ修正、最終検証

**成果物**: リリース可能なv1.0.0

---

## 5. 依存関係マップ

```
Phase 0 (環境準備)
  ↓
Phase 1 (静的HUD) ←─ 並行可能
  ↓                    ↓
Phase 2 (翻訳基盤) → 設定管理実装必須
  ↓
Phase 3 (OCR統合)
  ├─ 権限管理 (優先)
  ├─ キャプチャ (権限後)
  ├─ OCR (独立)
  └─ 統合 (全依存)
  ↓
Phase 4 (UX改善) ← Phase 3完了必須
  ↓
Phase 5 (配布) ← 全機能完成必須
```

### クリティカルパス
1. 環境準備 → 設定管理 → 翻訳API → OCR → 統合 → テスト → リリース

### 並行作業可能タスク
- HUD UI改善 と OCR実装
- ドキュメント作成 と テスト整備
- CI設定 と 署名手順確立

---

## 6. 検証チェックリスト

### 6.1 Phase 3 (MVP) 完了条件
- [ ] Screen Recording権限が正常に取得できる
- [ ] ショートカット（⌘⇧T等）でキャプチャが起動する
- [ ] スクリーンショット→OCR→翻訳が6秒以内に完了する
- [ ] HUDに原文と訳文が正しく表示される
- [ ] コピーボタンで訳文がクリップボードにコピーされる
- [ ] 閉じるボタンとEscキーでHUDが閉じる
- [ ] DeepL APIキーがKeychainに保存される
- [ ] 設定（言語、ショートカット）が再起動後も保持される
- [ ] 連続20回のテストで成功率95%以上
- [ ] エラー時に適切なメッセージが表示される

### 6.2 パフォーマンス検証
- [ ] 1920x1080スクリーンショットの処理時間 < 6秒
- [ ] HUDウィンドウのメモリ使用量 < 50MB
- [ ] アプリ起動時間 < 3秒
- [ ] OCR精度 > 80%（標準テキスト）

### 6.3 セキュリティ検証
- [ ] APIキーがKeychainに保存されている
- [ ] 一時ファイルが処理後に削除される
- [ ] ログに機密情報が含まれない
- [ ] HTTPS通信が正しく行われる

### 6.4 配布前検証
- [ ] 署名済みDMGがGatekeeperを通過する
- [ ] 別環境（クリーンなMac）でインストール可能
- [ ] README通りにセットアップできる
- [ ] 全ての設定項目が動作する

---

## 7. リスク管理

### 高リスクタスク

| リスク項目 | 影響度 | 対策 | 担当フェーズ |
|----------|--------|------|------------|
| Screen Recording権限が取得できない | 高 | 詳細なガイドUI、手動設定案内 | Phase 3 |
| OCR精度不足 | 高 | 画像前処理、複数言語モデル | Phase 3 |
| 処理時間が6秒超過 | 中 | Worker使用、画像縮小、並列化 | Phase 3 |
| DeepL API制限超過 | 中 | 使用量表示、代替API設定 | Phase 2 |
| マルチディスプレイ対応 | 中 | ディスプレイ選択UI | Phase 3 |
| 公証プロセス失敗 | 低 | 事前テスト、詳細手順書 | Phase 5 |

---

## 8. AIエージェント活用ガイド

### 8.1 タスク依頼の粒度
各タスクは以下の単位でAIエージェントに依頼可能:
- **小タスク**: 0.5-1日分（例: SettingsStore.jsの実装）
- **中タスク**: 2-3日分（例: TranslationService完全実装）
- **大タスク**: 1週間分（例: Phase 2全体）

### 8.2 依頼テンプレート例

```
【タスク】: [タスク番号] [タスク名]
【目的】: [何を実現するか]
【入力】: [既存ファイル、設定情報]
【出力】: [作成するファイル、検証結果]
【検証条件】: [完了判定基準]
【参考】: [関連ドキュメント]
```

### 8.3 検証方法の明示
各タスク完了時に以下を実行:
1. コードレビュー（AIまたは人間）
2. ユニットテスト実行
3. 手動動作確認
4. チェックリストへの記録

---

## 9. 進捗管理

### 9.1 進捗記録フォーマット

```markdown
## Week [N] 進捗レポート
**期間**: YYYY-MM-DD ~ YYYY-MM-DD
**完了タスク**: 
- [x] タスク 1.1.1
- [x] タスク 1.1.2

**進行中タスク**:
- [ ] タスク 1.2.1 (進捗 70%)

**ブロッカー**:
- なし

**次週予定**:
- タスク 1.3.1 ~ 1.3.4
```

### 9.2 マイルストーン

| マイルストーン | 予定日 | 完了条件 |
|--------------|--------|---------|
| M1: 環境準備完了 | Week 1 | npm test成功 |
| M2: 静的HUD表示 | Week 1 | HUD表示確認 |
| M3: 手動翻訳動作 | Week 3 | テキスト翻訳成功 |
| M4: MVP完成 | Week 7 | 全フロー動作 |
| M5: UX改善完了 | Week 9 | 全機能実装 |
| M6: リリース | Week 12 | 配布可能 |

---

## 10. 完了定義 (Definition of Done)

各タスク完了時、以下を全て満たすこと:
1. ✅ コードが実装されている
2. ✅ ユニットテストが書かれている（該当する場合）
3. ✅ テストが全てパスしている
4. ✅ ESLintエラーがゼロ
5. ✅ 手動動作確認が完了している
6. ✅ 関連ドキュメントが更新されている
7. ✅ コミットメッセージが適切
8. ✅ チェックリストにチェックが入っている

---

**このドキュメントは開発の進行に合わせて随時更新してください**

最終更新: 2025-09-30
